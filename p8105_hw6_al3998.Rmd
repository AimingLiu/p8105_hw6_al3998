---
title: "p8105_hw6_al3998"
author: "AimingLiu"
date: "11/15/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(dplyr)
library(modelr)
library(mgcv)

set.seed(1)
```

## Problem 1
```{r message = FALSE}
child_birth_data = read_csv("./data/birthweight.csv") %>% 
janitor::clean_names() %>% 
  mutate(babysex = factor(recode(babysex,"1" = "male","2" = "famle" )),
        frace = factor(recode(frace,"1" = "White","2" = "Black" ,"3" = "Asian", "4"= "Puerto Rican","8"  = "Other", "9" = "Unknown")),
        mrace = factor(recode(mrace,"1" = "White","2" = "Black" ,"3" = "Asian", "4"= "Puerto Rican","8"  = "Other")),
        malform = factor(recode(malform,"0" = "absent","1" = "present")))
```
## Propose a regression model for birthweigh

Child's birth weight may depend on the factor 'mrace' which tells us about the mother's race,'smoken' which tells us about the average number of cigarettes smoked per day during pregnancy.

I fit the model in the following chunk
```{r}
 fit = lm(bwt ~ smoken + mrace,data = child_birth_data)
 
  fit %>% 
  broom::tidy() %>% 
  select(term, estimate, p.value) %>% 
  mutate(term = str_replace(term, "^mrace", "Race: ")) %>% 
  knitr::kable()
```
```{r message = FALSE }
modelr::add_residuals(child_birth_data, fit)
modelr::add_predictions(child_birth_data, fit)
```

### Show a plot of model residuals against mother's race

```{r}
child_birth_data %>% 
  modelr::add_residuals(fit) %>% 
  ggplot(aes(x =mrace, y = resid)) + 
  geom_violin()+
  labs(title = "Residuals against Mother's race",x = "Mother race",y = "Residual")
```

### Show a plot of model residuals against mother's average number of cigarettes smoked per day during pregnancy

```{r}
child_birth_data %>% 
  modelr::add_residuals(fit) %>% 
  ggplot(aes(x = smoken, y = resid)) + 
  geom_point(alpha = .5)+
  labs(title = "Residuals against average number of cigarettes smoked",x = "Smoken",y = "Residual")
```

```{r}
model_1 = lm(bwt ~ blength + gaweeks,data = child_birth_data)
model_2 = lm(bwt ~ bhead*blength + bhead*babysex + blength*babysex + bhead*babysex*blength,data = child_birth_data)
```



### Hypothesis testing

Compare my model to two others
```{r}
cv_df =
  crossv_mc(child_birth_data, 100) %>% 
  mutate(
    train = map(train, as_tibble),
    test = map(test, as_tibble))

cv_df = 
  cv_df %>% 
  mutate(fit_mod = map(train,~lm(bwt ~ smoken + mrace,data = .x)),
         model_1_mod = map(train, ~lm(bwt ~ blength + gaweeks,data = .x)),
         model_2_mod = map(train, ~lm(bwt ~ bhead*blength + bhead*babysex + blength*babysex + bhead*babysex*blength,data = .x))) %>% 
   mutate(rmse_fit = map2_dbl(fit_mod, test, ~rmse(model = .x, data = .y)),
         rmse_model_1 = map2_dbl(model_1_mod, test, ~rmse(model = .x, data = .y)),
         rmse_model_2 = map2_dbl(model_2_mod, test, ~rmse(model = .x, data = .y)))
```

```{r}
cv_df %>% 
  select(starts_with("rmse")) %>% 
pivot_longer(
    everything(),
    names_to = "model", 
    values_to = "rmse",
    names_prefix = "rmse_") %>% 
  mutate(model = fct_inorder(model)) %>% 
  ggplot(aes(x = model, y = rmse)) + geom_violin()
```

